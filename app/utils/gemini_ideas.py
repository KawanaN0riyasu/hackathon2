import os
import re
from dotenv import load_dotenv
import google.generativeai as genai
from utils.data_collector import collect_reflection_data

# ğŸ”§ GeminiåˆæœŸåŒ–ï¼ˆ.envã‹ã‚‰APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚€ï¼‰
load_dotenv()
api_key = os.environ.get("GEMINI_API_KEY")
genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-1.5-flash")


def generate_app_ideas():
    """
    ç›¸è«‡è¨˜éŒ²ã‹ã‚‰æ•™å¸«å‘ã‘ã‚¢ãƒ—ãƒªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’3ã¤ç”Ÿæˆã™ã‚‹
    """
    reflection_data = collect_reflection_data()
    prompt = build_prompt_from_data(reflection_data)
    response = model.generate_content(prompt).text
    ideas = parse_app_ideas(response)  # â† parseé–¢æ•°ã¯åˆ¥é€”å®Ÿè£…
    return ideas


def build_prompt_from_data(reflection_data: list[dict]) -> str:
    """
    ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«Geminiç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹
    """
    section_map = {item["ã‚»ã‚¯ã‚·ãƒ§ãƒ³"]: item["å†…å®¹"] for item in reflection_data}

    # ç©ºæ¬„æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€å‡ºåŠ›å“è³ªãŒå®‰å®šã—ã¾ã™
    def get(section_name: str) -> str:
        return section_map.get(section_name) or "ï¼ˆæœªå…¥åŠ›ï¼‰"

    # å„è¦ç´ ã‚’æŠ½å‡º
    worry = get("å›°ã‚Šã”ã¨")
    challenge = get("å–ã‚Šçµ„ã‚€èª²é¡Œ")
    environment = get("ä»•äº‹ç’°å¢ƒ(ä½“åˆ¶ãƒ»ä»•çµ„ã¿ãƒ»åˆ†æ‹…)")
    creativity = get("å€‹äººã®å‰µæ„å·¥å¤«")
    wishes = get("å¶ãˆãŸã„ã“ã¨")

    # Geminiã¸ã®æŒ‡ç¤ºæ–‡
    prompt = f"""
ã‚ãªãŸã¯æ•™å¸«å‘ã‘ã®èª²é¡Œè§£æ±ºå‹ã‚¢ãƒ—ãƒªã‚’ææ¡ˆã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®ç›¸è«‡å†…å®¹ã‚’ã‚‚ã¨ã«ã€Streamlitã‚¢ãƒ—ãƒªã¨ã—ã¦ã€90minç¨‹åº¦ã§å†™çµŒã§ãã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’3ã¤è€ƒãˆã¦ãã ã•ã„ã€‚

## å…±é€šæ¡ä»¶
- ã€Œå›°ã‚Šã”ã¨ã€ã¨ã€Œå–ã‚Šçµ„ã‚€èª²é¡Œã€ã‚’è¸ã¾ãˆã¦è€ƒæ¡ˆã—ã¦ãã ã•ã„
- ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã™ã¹ã¦ç•°ãªã‚‹åˆ‡ã‚Šå£ã§é‡è¤‡ã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„
- åˆå­¦è€…ã®å…ˆç”Ÿã«ã‚‚ã‚ã‹ã‚Šã‚„ã™ãè¦ªã—ã‚“ã§ã‚‚ã‚‰ã†ãŸã‚ã€ã‚¢ã‚¤ã‚³ãƒ³ç­‰ä½¿ã„ãªãŒã‚‰ç°¡æ½”ãªè¡¨ç¾ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„

## ã‚¢ã‚¤ãƒ‡ã‚¢1
- ä»•äº‹ç’°å¢ƒï¼ˆä½“åˆ¶ãƒ»ä»•çµ„ã¿ãƒ»åˆ†æ‹…ï¼‰
- å€‹äººã®å‰µæ„å·¥å¤«
- å¶ãˆãŸã„ã“ã¨
ã“ã‚Œã‚‰ã®è¦–ç‚¹ã‚‚è€ƒæ…®ã—ã¦ãã ã•ã„

## ã‚¢ã‚¤ãƒ‡ã‚¢2
- ã‚¢ã‚¤ãƒ‡ã‚¢1ã®è¦–ç‚¹ã¨ã¯ç•°ãªã‚‹è¦³ç‚¹ã§
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›²ç‚¹ã‚’çªãæ—¢å­˜ã®ç¿’æ…£ã«å›šã‚ã‚Œãªã„ææ¡ˆ

## ã‚¢ã‚¤ãƒ‡ã‚¢3
- ã‚¢ã‚¤ãƒ‡ã‚¢1ãƒ»2ã¨ã¯é•ã†åˆ‡ã‚Šå£ã§
- ä»•äº‹ç’°å¢ƒï¼ˆä½“åˆ¶ãƒ»ä»•çµ„ã¿ãƒ»åˆ†æ‹…ï¼‰
- å€‹äººã®å‰µæ„å·¥å¤«
- å¶ãˆãŸã„ã“ã¨
ã“ã‚Œã‚‰ã®è¦–ç‚¹ã‚’è€ƒæ…®ã—ãŸææ¡ˆ


## æ•™å¸«ã®ç›¸è«‡å†…å®¹
å›°ã‚Šã”ã¨ï¼š{worry}
å–ã‚Šçµ„ã‚€èª²é¡Œï¼š{challenge}
ä»•äº‹ç’°å¢ƒï¼ˆä½“åˆ¶ãƒ»ä»•çµ„ã¿ãƒ»åˆ†æ‹…ï¼‰ï¼š{environment}
å€‹äººã®å‰µæ„å·¥å¤«ï¼š{creativity}
å¶ãˆãŸã„ã“ã¨ï¼š{wishes}

## å‡ºåŠ›å½¢å¼
ã€1ã¤ç›®ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã€‘
ã‚¿ã‚¤ãƒˆãƒ«ï¼š
èª¬æ˜ï¼š
    ãƒ»ç”¨é€”
    ãƒ»æ‰±ã†æŠ€è¡“
    ãƒ»ã‚ˆã‚Šæ¥½ã—ãä½¿ã†ãŸã‚ã«

ã€2ã¤ç›®ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã€‘
ã‚¿ã‚¤ãƒˆãƒ«ï¼š
èª¬æ˜ï¼š
    ãƒ»ç”¨é€”
    ãƒ»æ‰±ã†æŠ€è¡“
    ãƒ»ã‚ˆã‚Šæ¥½ã—ãä½¿ã†ãŸã‚ã«

ã€3ã¤ç›®ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã€‘
ã‚¿ã‚¤ãƒˆãƒ«ï¼š
èª¬æ˜ï¼š
    ãƒ»ç”¨é€”
    ãƒ»æ‰±ã†æŠ€è¡“
    ãƒ»ã‚ˆã‚Šæ¥½ã—ãä½¿ã†ãŸã‚ã«
"""
    return prompt.strip()


def parse_app_ideas(response_text: str) -> list[dict]:
    """
    Geminiã®å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚¢ã‚¤ãƒ‡ã‚¢3ä»¶åˆ†ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜ã‚’æŠ½å‡ºã™ã‚‹
    """
    ideas = []

    # å„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’åŒºåˆ‡ã‚‹ãŸã‚ã®æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³
    pattern = r"ã€\d+ã¤ç›®ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã€‘\s*ã‚¿ã‚¤ãƒˆãƒ«ï¼š(.+?)\s*èª¬æ˜ï¼š(.+?)(?=ã€|\Z)"
    matches = re.findall(pattern, response_text, re.DOTALL)

    for title, description in matches:
        ideas.append({
            "title": title.strip(),
            "description": description.strip()
        })

    return ideas
